---
title: Interference of doubly charged rare earth elements with arsenic and selenium
  quantitation
author: "Ben Colman"
date: '2023-09-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = FALSE}
library(Rmisc) # For summarySE function, load before tidyverse
library(multcomp) # For cld, load before tidyverse
library(tidyverse)
library(ggpubr)
library(cowplot)
library(scales)
library(stringr)
library(car)
library(viridisLite)
library(emmeans)
library(xlsx)
library(magrittr)
library(kableExtra)
```

```{r aesthetics, echo = FALSE}

# Get rid of scientific notation
options(scipen = 8)

# Set a theme for consistency in plots
theme_set(theme_bw() + 
            theme(axis.title.x = element_text( size=16),
                  panel.grid = element_blank(),
                  axis.title.y = element_text( size=16),
                  axis.text.x = element_text(size = 12),
                  axis.text.y = element_text(size = 12),
                  legend.title = element_text(size = 12),
                  legend.text=element_text(size=12),
                  strip.text = element_text(size = 12))
          )
```

```{r Importing data, echo=FALSE}
calib_rsq <- read.xlsx("./01_input/standard_curve_fits.xlsx", sheetIndex = 1,
                       colClasses = c("numeric", 
                                      "character", 
                                      "character", 
                                      "character",
                                      "numeric", 
                                      "numeric",
                                      "numeric", 
                                      "numeric", 
                                      "character")) 

colnames(calib_rsq) <- c("isotope", "element", "mode", "curve_type", "other_r2",
"slope", "intercept", "r2", "notes")

conc_all <- read.xlsx("./01_input/as_se_app_note_data.xlsx", sheetIndex = 5) %>%
  select(2, 8:66) %>%
  select(-starts_with("Rh"), -starts_with("Kr")) 

conc_all <- conc_all[-c(5, 63), ] # Removed bad data due to bad IS due to instrument

names <- colnames(conc_all)

names <- 
  gsub("\\.", " ", names) %>%
  gsub("Sample Id", "samp_id", .) %>%
  gsub("  ", " ", .) %>%
  gsub("  ", " ", .) %>% 
  gsub(" Helium.KED_LowLow ppb ", "", .) %>%
  gsub(" Oxygen DRC ppb ", "", .) %>%
  gsub(" Ammonia DRC ppb ", "", .) %>%
  gsub("Oxygen DRC ppb", "", .) %>%
  gsub(" Hydrogen DRC ppb ", "", .) %>%
  gsub("As ", "As 75 ", .) %>%
  gsub("As 75 75", "As 75 ", .) %>%
  gsub("O2 MSMS", "o2_msms", .) %>%
  gsub("KED", "ked", .) %>%
  gsub("O2 Q3", "o2q3 XX", .) %>%
  gsub("OShift", "oshift", .) %>%
  gsub("NH3", "nh3", .) %>%
  gsub("H", "h", .) 

colnames(conc_all) <- 
  names


conc_longer <- 
  pivot_longer(conc_all,
               2:49, 
               names_to = "isomodes", 
               values_to = "conc") %>%
  separate("isomodes", into = c("isotope", "mode", "masses"),sep = c(5,-5)) %>%
  select(-masses) 

conc_longer$mode %<>% 
  gsub(" ", "", .) %>%
  gsub("[0-9]+[0-9]+[0-9]+[0-9]", "std", .) %>%
  gsub("[0-9]+[0-9]", "std", .) 

conc_longer %<>% 
    mutate(
      mode = ordered(
        mode, 
        levels = c("std",
                   "ked", 
                   "h", 
                   "nh3", 
                   "o2_msms", 
                   "o2q3", 
                   "oshift")))


conc_blank <- 
  filter(conc_longer, samp_id == "LBLANK")

conc_blank_summary <- 
  summarySE(conc_blank, 
            measurevar = "conc", 
            groupvars = c("isotope", "mode")) %>%
  select(1:5) %>%
  mutate(mdl = sd*qt(0.01, N - 1, lower.tail = FALSE),
         mdl_b = ifelse(conc >= 0, mdl + conc, mdl))

conc_ccv <- 
  filter(conc_longer, samp_id == "CCV 10ppb")

conc_ccv_summary <- 
  summarySE(conc_ccv,
            measurevar = "conc",
            groupvars = c("isotope", "mode"))

conc_srs <- 
  filter(conc_all, samp_id %in% c("PPREE1", "SCREE1", paste0("T", 223:249)))
```

## Overview
The purpose of this experiment was to examine the degree to which analysis of arsenic (As) and selenium (Se) interfere with one another and are interfered with by a selection of doubly charged rare earth elements including:
* Dysprosium (Dy)
* Erbium (Er
* Europium (Eu)
* Gadolinium (Gd)
* Holmium (Ho)
* Neodymium (Nd)
* Samarium (Sm)

## Standard curves:
For this experiment, we ran single element standard curves at 0, 0.1, 1, 10, and 100 ppb for both As and Se. In fitting the standard curves, no samples were omitted and the same samples were used for all the different isotopes and modes for each element. All curves were initially fit with a weighted linear regression, and data were examined visually for how well they fit for the high concentration samples. If the for the high concentration samples was not within ~5% of the expected value, we examined whether switching to a "simple linear" fit resulted in a better or worse fit for the high concentration data. We then examined the low concentration samples to see how well they were fit. If they were fit reasonably well, we accepted the fit. In those cases where the high concentration data were poorly fit by the weighted linear regression and we changed the fit to a simple linear model, this generally  resulted in a less robust fit at low concentrations, but a dramatic increase in the R$^2$. 

## Determining the method detection limit:
There are several different approaches for calculating method detection limits. The approaches generally take into account the variability in repeated measurements of either a blank or a low concentration sample, and can also take into account the concentration measured for blanks. For this study, we chose to follow a version of the EPA's 2016 updated guidance, which recommends establishing initial detection limits by repeated measurements of blanks, while accounting for the calculated concentration of elements in blanks.

$$MDL_b~=~\overline{X} +t_{(n~-~1,~1~-~\alpha~=~0.99)}S_b$$
$MDL_b$ = the MDL based on method blanks
$\overline{X}$ = the mean of the method blank results (use 0 if mean is negative)
$t_{(n~-~1,~1~-~\alpha~=~0.99)}$ = the student's t-value appropriate for the single-tailed 99th percentile t-statistic for n-1 degrees of freedom
$S_b$ = standard deviation of method blank analyses


```{r mdl table}
conc_mdl_b_table <- 
  conc_blank_summary %>%
  mutate(mdl_b = round(mdl_b, digits = 3)) %>%
  pivot_wider(names_from = isotope, 
              values_from = mdl_b, 
              id_cols = mode)

conc_mdl_b_table_formatted <- conc_mdl_b_table 

conc_mdl_table <- 
  conc_blank_summary %>%
  mutate(mdl = round(mdl, digits = 3)) %>%
  pivot_wider(names_from = isotope, 
              values_from = mdl, 
              id_cols = mode)

conc_mdl_table_formatted <- conc_mdl_table 

# Generate labels for isotope_labels that will be parsed
# First pull in the levels to be converted
isotope_labels_table <- 
  c(levels(as.factor(conc_longer$isotope)))

# Separate the levels
isotope_labels_table <- data.frame(labels = isotope_labels_table) %>%
  separate(., labels, into = c("element", "isotope"), sep = " ")

# Recombine the levels and convert back to a vector
isotope_labels_table <- 
  as.vector(
    paste0("<sup>", isotope_labels_table$isotope, "</sup>", isotope_labels_table$element))

colnames(conc_mdl_b_table_formatted) <- rbind(c("Mode", isotope_labels_table))
colnames(conc_mdl_table_formatted) <- rbind(c("Mode", isotope_labels_table))


mode_labels_table <- 
  c("No Gas",
    "KED",
    "H<sub>2</sub> MSMS", 
    "NH<sub>3</sub> MSMS", 
    "O<sub>2</sub> MSMS",
    "O<sub>2</sub> Q3",
    "O<sub>2</sub> Shift")

conc_mdl_b_table_formatted[ ,1] <- 
  mode_labels_table

conc_mdl_table_formatted[ ,1] <- 
  mode_labels_table

(mdl_b_table <-
  conc_mdl_b_table_formatted %>%
  kbl(escape = FALSE,
      format = "html",
      caption = "Table 1: Method detection limits on method blanks 
      (MDL<sub>b</sub>) calculated using EPA 2016 guidelines for 
      all isotopes in all modes.") %>% 
  kable_classic(full_width = F, 
                html_font = "Cambria",
                font_size = 24)
)

(mdl_table <-
  conc_mdl_table_formatted %>%
  kbl(escape = FALSE,
      format = "html",
      caption = "Table 2: Method detection limits on method blanks 
      (MDL) calculated using older EPA guidelines for 
      all isotopes in all modes.") %>% 
  kable_classic(full_width = F, 
                html_font = "Cambria",
                font_size = 24)
)
# Save table to image: save_kable(blank_table, "./03_incremental/as_se_mdl.png")
```
```{r table of R2 values}
calib_rsq_table_formatted <- calib_rsq %>%
  mutate(
    mode = ordered(
      mode,
      levels = c("Standard", 
                 "KED", 
                 "H2", 
                 "NH3", 
                 "O2 MSMS", 
                 "O2 Q3 Only", 
                 "O2 Mass Shift")),
    mode = fct_recode(
      mode, 
      "No Gas" = "Standard",
      "KED" = "KED",
      "H<sub>2</sub> MSMS" = "H2",
      "NH<sub>3</sub> MSMS" = "NH3",
      "O<sub>2</sub> MSMS" = "O2 MSMS",
      "O<sub>2</sub> Q3" = "O2 Q3 Only",
      "O<sub>2</sub> Shift" = "O2 Mass Shift"),
    isotope = paste0("<sup>", isotope, "</sup>", element), 
    r2 = round(r2, digits = 4),
    .keep = "unused") %>%
  select(isotope, r2, mode) %>%
  pivot_wider(., names_from = "isotope", values_from = "r2",)

colnames(calib_rsq_table_formatted) <- c("Mode", isotope_labels_table)

(calib_rsq_table <-
  calib_rsq_table_formatted %>%
  arrange(Mode) %>%
    kbl(escape = FALSE,
      format = "html",
      caption = "Table 3: R<sup>2</sup> values for standard curves for all 
      isotopes in all modes.") %>% 
  kable_classic(full_width = F, 
                html_font = "Cambria",
                font_size = 24)
)
```


```{r single element plots: EPA MDL, fig.height = 12, fig.width = 10}
conc_single <- 
  filter(conc_longer, 
         !samp_id %in% 
           c("LBLANK", "CAL BLANK", "CCV 10ppb", paste0("T", 223:249), "PPREE1", "SCREE1"),
         str_detect(samp_id, "^AsSe", negate = TRUE))


conc_single %<>%
  separate("samp_id", into = c("element", "amount"), sep = " ") %>%
  mutate(
    element = ordered(element, 
                      levels = c("As", "Se", "Dy", "Er", "Eu", "Gd", "Ho",
                                 "Nd", "Sm")),
    amount = as.numeric(amount))

conc_single_cen_mdl_b <-
  merge(conc_single, 
        conc_blank_summary %>% 
          select(1,2,7), 
        by.x = c(3, 4), 
        by.y = c(1,2), 
        all.y = TRUE) %>%
  mutate(conc = ifelse(mdl_b >= conc, 0.5 * mdl_b, conc)) %>%
  select(-mdl_b)

# Generate labels for mode that will be parsed
mode_labels <- 
  c("No~Gas",
    "KED",
    "H[2]~MSMS", 
    "NH[3]~MSMS", 
    "O[2]~MSMS",
    "O[2]~Q3",
    "O[2]~Shift")

# Name labels to align with existing values
names(mode_labels) <- levels(as.factor(conc_single_cen_mdl_b$mode))

# Generate labels for isotope_labels that will be parsed
# First pull in the levels to be converted
isotope_labels <- 
  c(levels(as.factor(conc_single_cen_mdl_b$isotope)))

# Separate the levels
isotope_labels <- data.frame(labels = isotope_labels) %>%
  separate(., labels, into = c("element", "isotope"), sep = " ")

# Recombine the levels and convert back to a vector
isotope_labels <- 
  as.vector(
    paste0("''^", isotope_labels$isotope, "*", isotope_labels$element))

names(isotope_labels) <- levels(as.factor(conc_single_cen_mdl_b$isotope))

(measured_conc_by_element_fig <- ggplot(
  conc_single_cen_mdl_b %>%
    mutate(
      mode = factor(mode, labels = mode_labels),
      isotope = factor(isotope, labels = isotope_labels)),
    aes(x = amount, y = conc)
  ) +
  geom_line(aes(group = element, color = element)) +
  geom_point(aes(group = element, color = element, shape = element)) +
  scale_y_continuous(trans = pseudo_log_trans(sigma = 0.01, base = 10),
                     breaks = c(0, 0.01, 0.1, 1, 10, 100, 1000),
                     labels = c("0", "", "0.1", "1", "10", "100", "1000")) +
  scale_x_log10() +
  labs(x = "Concentration added of\n As, Se, or individual REE (ppb)", 
       y = "Measured concentration, As or Se (ppb)") +
  scale_color_viridis_d(name = "Element added") +
  scale_shape_manual(name = "Element added",, values = c(0, 15, 1, 16, 2, 17, 5, 6, 25)) +
  theme(axis.text.x = element_text(angle = 60,hjust = 1)) +
  geom_hline(data = conc_blank_summary %>% 
               mutate(
                 mode = factor(mode, labels = mode_labels),
                 isotope = factor(isotope, labels = isotope_labels)), 
             aes(yintercept = 0.5*mdl_b), color = "red", linetype = 2) +
  facet_grid(mode ~ isotope, labeller = as_labeller(label_parsed)))


```


```{r multi element plots: EPA MDL, fig.height = 12, fig.width = 10}
conc_multi <- 
  filter(conc_longer, 
         !samp_id %in% 
           c("LBLANK", "CAL BLANK", "CCV 10ppb", paste0("T", 223:249), "PPREE1", "SCREE1"),
         str_detect(samp_id, "^AsSe", negate = FALSE))

conc_multi$samp_id %<>%  
  gsub("AsSe ", "", .) %>%
  gsub("REE ", "", .)

conc_multi %<>%
  separate("samp_id", into = c("expected", "ree"), sep = " ") %>%
  mutate(expected = as.ordered(expected), ree = as.numeric(ree)) %>%
  rbind(., conc_blank_summary %>%
          mutate(expected = 0, ree = 0) %>%
        select(1, 2, 8, 9, 4))

conc_multi_cen_mdl_b <-
  merge(conc_multi, 
        conc_blank_summary %>% 
          select(1,2,7), 
        by.x = c(3, 4), 
        by.y = c(1,2), 
        all.y = TRUE) %>%
  mutate(conc = ifelse(mdl_b >= conc, 0.5*mdl_b, conc)) %>%
  select(-mdl_b)

# Generate a plot with facets, and with parsed facet labels drawn from the data.frame
(measured_conc_by_ree_conc_fig <-
  ggplot(
    conc_multi_cen_mdl_b %>%
      mutate(
        mode = factor(mode, labels = mode_labels),
        isotope = factor(isotope, labels = isotope_labels)
        ),
      aes(x = ree, y = conc)
    ) +
    geom_line(aes(group = expected, color = expected)) +
    geom_point(aes(group = expected, color = expected)) +
    scale_y_continuous(trans = pseudo_log_trans(sigma = 0.01, base = 10),
                  breaks = c(0, 0.01, 0.1, 1, 10, 100, 1000),
                  labels = c("0", "", "0.1", "1", "10", "100", "1000")
                  ) +
    scale_x_continuous(trans = pseudo_log_trans(sigma = 0.01, base = 10),
                       breaks = c(0, 0.01, 0.1, 1, 10),
                       labels = c("0", "", "0.1", "1", "10")) +
    labs(x = "Concentration REE mixture (ppb)", 
         y = "Measured concentration, As or Se (ppb)"
         ) +
    scale_color_viridis_d(
      name = "Actual \nConcentration \nAs or Se \n(ppb)") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    geom_hline(data = conc_blank_summary %>% 
             mutate(
               mode = factor(mode, labels = mode_labels),
               isotope = factor(isotope, labels = isotope_labels)), 
             aes(yintercept = mdl_b/2), color = "red", linetype = 2) +
    facet_grid(mode ~ isotope, labeller = as_labeller(label_parsed)
               )
  )


```

```{r saving plots, include = FALSE, echo = FALSE}
save_plot("./03_incremental/measured_conc_by_element.png",
          measured_conc_by_element_fig, 
          base_height = 12, 
          base_width = 10
          )

save_plot("./03_incremental/measured_conc_by_ree_conc.png", 
          measured_conc_by_ree_conc_fig, 
          base_height = 12, 
          base_width = 10)
```

```{r plots with standard mdl and censoring, fig.height = 12, fig.width = 10}
conc_single_cen_typ <-
  merge(conc_single, 
        conc_blank_summary %>% 
          select(1,2,6), 
        by.x = c(3, 4), 
        by.y = c(1,2), 
        all.y = TRUE) %>%
  mutate(conc = ifelse(mdl >= conc, 0.5 * mdl, conc)) %>%
  select(-mdl)

conc_multi_cen_typ <-
  merge(conc_multi, 
        conc_blank_summary %>% 
          select(1,2,6), 
        by.x = c(3, 4), 
        by.y = c(1,2), 
        all.y = TRUE) %>%
  mutate(conc = ifelse(mdl >= conc, 0.5 * mdl, conc)) %>%
  select(-mdl)

(measured_conc_by_element_fig <- ggplot(
  conc_single_cen_typ %>%
    mutate(
      mode = factor(mode, labels = mode_labels),
      isotope = factor(isotope, labels = isotope_labels)),
    aes(x = amount, y = conc)
  ) +
  geom_line(aes(group = element, color = element)) +
  geom_point(aes(group = element, color = element, shape = element)) +
  scale_y_continuous(trans = pseudo_log_trans(sigma = 0.01, base = 10),
                     breaks = c(0, 0.01, 0.1, 1, 10, 100, 1000),
                     labels = c("0", "", "0.1", "1", "10", "100", "1000")) +
  scale_x_log10() +
  labs(x = "Concentration added of\n As, Se, or individual REE (ppb)", y = "Measured concentration, As or Se (ppb)") +
  scale_color_viridis_d(name = "Element added") +
  scale_shape_manual(name = "Element added",, values = c(0, 15, 1, 16, 2, 17, 5, 6, 25)) +
  theme(axis.text.x = element_text(angle = 60,hjust = 1)) +
  geom_hline(data = conc_blank_summary %>% 
               mutate(
                 mode = factor(mode, labels = mode_labels),
                 isotope = factor(isotope, labels = isotope_labels)), 
             aes(yintercept = 0.5*mdl), color = "red", linetype = 2) +
  facet_grid(mode ~ isotope, labeller = as_labeller(label_parsed)))

(measured_conc_by_ree_conc_fig <-
  ggplot(
    conc_multi_cen_typ %>%
      mutate(
        mode = factor(mode, labels = mode_labels),
        isotope = factor(isotope, labels = isotope_labels)
        ),
      aes(x = ree, y = conc)
    ) +
    geom_line(aes(group = expected, color = expected)) +
    geom_point(aes(group = expected, color = expected)) +
    scale_y_continuous(trans = pseudo_log_trans(sigma = 0.01, base = 10),
                  breaks = c(0, 0.01, 0.1, 1, 10, 100, 1000),
                  labels = c("0", "", "0.1", "1", "10", "100", "1000")
                  ) +
    scale_x_continuous(trans = pseudo_log_trans(sigma = 0.01, base = 10),
                       breaks = c(0, 0.01, 0.1, 1, 10),
                       labels = c("0", "", "0.1", "1", "10")) +
    labs(x = "Concentration REE mixture (ppb)", 
         y = "Measured concentration, As or Se (ppb)"
         ) +
    scale_color_viridis_d(
      name = "Actual \nConcentration \nAs or Se \n(ppb)") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    geom_hline(data = conc_blank_summary %>% 
             mutate(
               mode = factor(mode, labels = mode_labels),
               isotope = factor(isotope, labels = isotope_labels)), 
             aes(yintercept = 0.5*mdl), color = "red", linetype = 2) +
    facet_grid(mode ~ isotope, labeller = as_labeller(label_parsed)
               )
  )
```
